<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmberFrame Desktop - {{ username }}</title>

    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/desktop.css') }}">

    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Desktop Area -->
    <div class="desktop" id="desktop">
        <!-- Desktop Icons -->
        <div class="desktop-icon" style="top: 50px; left: 50px;" data-app="file-manager">
            <div class="icon-image">📁</div>
            <div class="icon-label">File Manager</div>
        </div>

        <div class="desktop-icon" style="top: 50px; left: 150px;" data-app="terminal">
            <div class="icon-image">💻</div>
            <div class="icon-label">Terminal</div>
        </div>

        <div class="desktop-icon" style="top: 150px; left: 50px;" data-app="text-editor">
            <div class="icon-image">📝</div>
            <div class="icon-label">Text Editor</div>
        </div>

        <div class="desktop-icon" style="top: 150px; left: 150px;" data-app="settings">
            <div class="icon-image">⚙️</div>
            <div class="icon-label">Settings</div>
        </div>

        <div class="desktop-icon" style="top: 250px; left: 50px;" data-app="public-folder">
            <div class="icon-image">🌐</div>
            <div class="icon-label">Public Files</div>
        </div>
    </div>

    <!-- Windows Container -->
    <div id="windows-container"></div>

    <!-- Taskbar -->
    <div class="taskbar">
        <button class="start-button" id="start-button">
            🔥 Start
        </button>

        <div class="taskbar-apps" id="taskbar-apps">
            <!-- Running applications will appear here -->
        </div>

        <div class="system-tray">
            <span class="username">{{ username }}</span>
            <div class="time" id="time">00:00</div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Start Menu -->
    <div class="start-menu" id="start-menu">
        <div class="start-menu-header">
            <h3>Applications</h3>
            <input type="text" class="start-menu-search" id="app-search" placeholder="Search apps...">
        </div>
        <div class="start-menu-apps">
            <div class="start-menu-app" data-app="file-manager">
                <div class="start-menu-app-icon">📁</div>
                <div class="start-menu-app-label">File Manager</div>
            </div>
            <div class="start-menu-app" data-app="terminal">
                <div class="start-menu-app-icon">💻</div>
                <div class="start-menu-app-label">Terminal</div>
            </div>
            <div class="start-menu-app" data-app="text-editor">
                <div class="start-menu-app-icon">📝</div>
                <div class="start-menu-app-label">Text Editor</div>
            </div>
            <div class="start-menu-app" data-app="settings">
                <div class="start-menu-app-icon">⚙️</div>
                <div class="start-menu-app-label">Settings</div>
            </div>
            <div class="start-menu-app" data-app="public-folder">
                <div class="start-menu-app-icon">🌐</div>
                <div class="start-menu-app-label">Public Files</div>
            </div>
        </div>
        <div class="start-menu-footer">
            <div class="start-menu-action" onclick="showSettings()">⚙️ Settings</div>
            <div class="start-menu-action logout" onclick="logout()">🚪 Logout</div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" data-icon="📄" onclick="createNewFile()">New File</div>
        <div class="context-menu-item" data-icon="📁" onclick="createNewFolder()">New Folder</div>
        <div class="context-menu-item" data-icon="⚙️" onclick="showProperties()">Properties</div>
    </div>

    <!-- File Browser Dialog -->
    <div class="file-browser-dialog" id="file-browser-dialog">
        <div class="file-browser-header">
            <div class="file-browser-title">File Browser</div>
            <button class="file-browser-close" onclick="FileBrowser.close()">×</button>
        </div>
        <div class="file-browser-toolbar">
            <button id="fb-back-btn" onclick="FileBrowser.goBack()" disabled>← Back</button>
            <button onclick="FileBrowser.goHome()">🏠 Home</button>
            <div class="file-browser-path">
                <span id="fb-current-path">/</span>
            </div>
        </div>
        <div class="file-browser-content">
            <div class="file-browser-list" id="file-browser-list">
                <div class="loading">Loading files...</div>
            </div>
        </div>
        <div class="file-browser-footer">
            <input type="text" id="fb-filename" placeholder="Filename" style="display: none;">
            <button id="fb-action-btn">Open</button>
            <button onclick="FileBrowser.close()">Cancel</button>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- JavaScript Files -->
    <script src="{{ url_for('static', filename='js/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/file-browser.js') }}"></script>
    <script src="{{ url_for('static', filename='js/window-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/desktop-core.js') }}"></script>

    <!-- Application Scripts -->
    <script src="{{ url_for('static', filename='js/apps/file-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/apps/text-editor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/apps/terminal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/apps/settings.js') }}"></script>

    <script>
        console.log('🔥 EmberFrame Desktop loaded for user: {{ username }}');

        // Global functions
        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                console.log('👋 Logging out user: {{ username }}');
                if (window.Notification) {
                    window.Notification.info('Signing out...');
                }
                setTimeout(() => {
                    window.location.href = '/logout';
                }, 1000);
            }
        }

        function showSettings() {
            if (window.WindowManager && window.Settings) {
                window.WindowManager.openApp('settings');
            }
        }

        function createNewFile() {
            if (window.WindowManager && window.TextEditor) {
                window.WindowManager.openApp('text-editor');
            }
        }

        function createNewFolder() {
            if (window.Notification) {
                window.Notification.info('New folder functionality coming soon');
            }
        }

        function showProperties() {
            if (window.WindowManager && window.Settings) {
                window.WindowManager.openApp('settings');
            }
        }

        // Initialize desktop when all scripts are loaded
        window.addEventListener('load', function() {
            console.log('🖥️ All scripts loaded, initializing desktop...');

            // Check if all required components are loaded
            const requiredComponents = ['WindowManager', 'Desktop', 'FileManager', 'TextEditor', 'Terminal', 'Settings'];
            const missingComponents = requiredComponents.filter(component => !window[component]);

            if (missingComponents.length > 0) {
                console.warn('⚠️ Missing components:', missingComponents);
                if (window.Notification) {
                    window.Notification.warning('Some applications may not be available');
                }
            } else {
                console.log('✅ All desktop components loaded successfully!');
                if (window.Notification) {
                    window.Notification.success('Welcome to EmberFrame Desktop! 🔥');
                }
            }a
        });

        // Error handling for missing scripts
        window.addEventListener('error', function(e) {
            console.error('Script error:', e.filename, e.message);
            if (e.filename && e.filename.includes('.js')) {
                console.warn('Failed to load:', e.filename);
            }
        });
    </script>
</body>
</html>